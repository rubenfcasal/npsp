<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Geoestadistica no parametrica con el paquete *npsp* • npsp</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Geoestadistica no parametrica con el paquete *npsp*">
<meta property="og:description" content="npsp">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">npsp</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.7-10</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../articles/npsp.html">Get started</a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/docs/aquifer.html">Geoestadistica no parametrica con el paquete *npsp*</a>
    </li>
    <li>
      <a href="../../articles/docs/Introduccion.html"> Introduccion a la Geoestadistica con R</a>
    </li>
    <li>
      <a href="../../articles/krigstat.html">Kriging with gstat</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rubenfcasal/npsp/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Geoestadistica no parametrica con el paquete
<em>npsp</em>
</h1>
                        <h4 data-toc-skip class="author">Ruben
Fernandez-Casal (<a href="mailto:ruben.fcasal@udc.es" class="email">ruben.fcasal@udc.es</a>)</h4>
            
            <h4 data-toc-skip class="date">npsp 0.7.10</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/rubenfcasal/npsp/blob/HEAD/../../../../E:/OneDrive%20-%20Universidade%20da%20Coru%C3%B1a/__R_Machinery/__npsp/npsp/vignettes/docs/aquifer.Rmd" class="external-link"><code>../../../../E:/OneDrive - Universidade da Coruña/__R_Machinery/__npsp/npsp/vignettes/docs/aquifer.Rmd</code></a></small>
      <div class="hidden name"><code>aquifer.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rubenfcasal/npsp" class="external-link">npsp</a></span><span class="op">)</span></span></code></pre></div>
<pre><code> Package npsp: Nonparametric Spatial Statistics,
 version 0.7-10 (built on 2023-04-20).
 Copyright (C) R. Fernandez-Casal 2012-2023.
 Type `help(npsp)` for an overview of the package or
 visit https://rubenfcasal.github.io/npsp.</code></pre>
<div class="section level2">
<h2 id="geoestadística-no-paramétrica">Geoestadística no paramétrica<a class="anchor" aria-label="anchor" href="#geoestad%C3%ADstica-no-param%C3%A9trica"></a>
</h2>
<p>Nos centraremos en el caso de procesos espaciales <span class="math inline">\(\left\lbrace Y(\mathbf{x}), \mathbf{x} \in
D\subset \mathbb{R}^{d} \right\rbrace\)</span>, con dominio <span class="math inline">\(D\)</span> continuo fijo: proceso
geoestadístico.</p>
<ul>
<li>El objetivo en el futuro es considerar procesos puntuales marcados:
<span class="math inline">\(D\)</span> es un proceso puntual en <span class="math inline">\(\mathbb{R}^{d}.\)</span>
</li>
</ul>
<p>Normalmente sólo se observa un conjunto de valores <span class="math inline">\(\left\{
y(\mathbf{x}_{1}),\ldots,y(\mathbf{x}_{n})\right\}\)</span>
(<strong>realización parcial</strong>).</p>
<div class="section level3">
<h3 id="ejemplo">Ejemplo<a class="anchor" aria-label="anchor" href="#ejemplo"></a>
</h3>
<p>Se utilizará como ejemplo el conjunto de datos <a href="https://rubenfcasal.github.io/npsp/reference/aquifer.html" class="external-link"><code>aquifer</code></a>:
nivel del agua subterránea en el acuífero Wolfcamp.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">aquifer</span><span class="op">)</span></span></code></pre></div>
<pre><code>'data.frame':   85 obs. of  3 variables:
 $ lon : num  42.78 -27.4 -1.16 -18.62 96.47 ...
 $ lat : num  127.6 90.8 84.9 76.5 64.6 ...
 $ head: num  1464 2553 2158 2455 1756 ...</code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#   Scatter plot with a color scale</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">aquifer</span>, <span class="fu"><a href="../../reference/spoints.html">spoints</a></span><span class="op">(</span><span class="va">lon</span>, <span class="va">lat</span>, <span class="va">head</span>, main <span class="op">=</span> <span class="st">"Wolfcamp aquifer data"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="aquifer_files/figure-html/unnamed-chunk-2-1.png" width="576" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="modelo-general">Modelo general<a class="anchor" aria-label="anchor" href="#modelo-general"></a>
</h3>
<p>Se supone que el proceso se descompone en <em>variabilidad de gran
escala</em> y <em>variabilidad de pequeña escala</em>: <span class="math display">\[Y(\mathbf{x})=\mu(\mathbf{x})+\varepsilon(\mathbf{x}),\]</span>
donde:</p>
<ul>
<li><p><span class="math inline">\(\mu(\cdot)\)</span> es la tendencia
(función determinística).</p></li>
<li><p><span class="math inline">\(\varepsilon(\cdot)\)</span> es un
proceso de error estacionario de segundo orden, de media cero y
covariograma: <span class="math display">\[C(\mathbf{u}) =
Cov(\varepsilon(\mathbf{x}),
\varepsilon(\mathbf{x}+\mathbf{u} ))\]</span> (varianza <span class="math inline">\(\sigma^2 = C(\mathbf{0})\)</span>).</p></li>
</ul>
<p>La dependencia espacial se modela normalmente a través del
variograma: <span class="math display">\[2\gamma(\mathbf{u}) =
Var(\varepsilon \left( \mathbf{x}\right)
-\varepsilon \left(\mathbf{x}+\mathbf{u}\right) ),\]</span> verificando
<span class="math inline">\(\gamma(\mathbf{u}) = C(0) -
C(\mathbf{u})\)</span>.</p>
<p>Se empleará un modelo <strong>no paramétrico</strong>: no se supone
ninguna forma concreta para <span class="math inline">\(\mu(\mathbf{\cdot})\)</span> y <span class="math inline">\(\gamma(\mathbf{\cdot})\)</span> (funciones
suaves).</p>
<ul>
<li><p>Evitan problemas debidos a una mala especificación del
modelo.</p></li>
<li><p>Más fáciles de automatizar.</p></li>
<li><p>Resultan también de utilidad en inferencia paramétrica.</p></li>
</ul>
</div>
<div class="section level3">
<h3 id="ejemplo-1">Ejemplo<a class="anchor" aria-label="anchor" href="#ejemplo-1"></a>
</h3>
<p>Con el conjunto de datos de ejemplo puede ser preferible emplear
métodos paramétricos. El tamaño muestral es pequeño y un modelo lineal
para la tendencia parece ser adecuado.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">aquifer</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>      <span class="co"># coordenadas espaciales</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">aquifer</span><span class="op">$</span><span class="va">head</span><span class="op">/</span><span class="fl">100</span>   <span class="co"># respuesta (en cientos de pies)</span></span>
<span><span class="fu"><a href="../../reference/scattersplot.html">scattersplot</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, main <span class="op">=</span> <span class="st">"Wolfcamp aquifer data"</span>, xlab <span class="op">=</span> <span class="st">'lon'</span>, ylab <span class="op">=</span><span class="st">'lat'</span>, </span>
<span>             zlab <span class="op">=</span> <span class="st">'piezometric-head'</span>, col <span class="op">=</span> <span class="fu"><a href="../../reference/splot.html">jet.colors</a></span><span class="op">(</span><span class="fl">128</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="aquifer_files/figure-html/unnamed-chunk-3-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="inferencia-no-paramétrica-en-procesos-geoestadísticos">Inferencia (no paramétrica) en procesos geoestadísticos<a class="anchor" aria-label="anchor" href="#inferencia-no-param%C3%A9trica-en-procesos-geoestad%C3%ADsticos"></a>
</h3>
<p>A partir de los valores observados <span class="math inline">\(\mathbf{Y}=(Y(\mathbf{x}_1),\ldots,Y(\mathbf{x}_n))^{t}\)</span>
puede interesar:</p>
<ul>
<li><p>Obtener predicciones (kriging): <span class="math inline">\(\hat{Y}(\mathbf{x}_0)\)</span>.</p></li>
<li><p>Realizar inferencias (estimación, contrastes) sobre las
componentes del modelo <span class="math inline">\(\hat{\mu}(\cdot)\)</span>, <span class="math inline">\(\hat{\gamma}(\cdot)\)</span>.</p></li>
<li><p>Obtención de mapas de riesgo <span class="math inline">\(P({Y}(\mathbf{x}_0)\geq c)\)</span></p></li>
<li><p>…</p></li>
</ul>
<p>Aunque hay una gran cantidad de paquetes de R con herramientas de
utilidad en geoestadística (<code>geoR</code>, <code>gstat</code>,
<code>fields</code>, …) o en estadística no paramétrica
(<code>mgcv</code>, <code>KernSmooth</code>, <code>sm</code>, …), la
mayoría presentan una funcionalidad muy limitada para estadística
espacial no paramétrica o resulta difícil emplearlos para implementar
nuevos métodos (además de otras limitaciones, como su eficiencia
computacional o el número de dimensiones que soportan). Por este motivo
se decidió desarrollar el paquete <a href="https://rubenfcasal.github.io/npsp" class="external-link"><code>npsp</code></a>:</p>
<ul>
<li><p>CRAN: <a href="https://cran.r-project.org/package=npsp" class="external-link uri">https://cran.r-project.org/package=npsp</a></p></li>
<li><p>Github: <a href="http://github.com/rubenfcasal/npsp" class="external-link uri">http://github.com/rubenfcasal/npsp</a></p></li>
</ul>
<p>La idea sería:</p>
<ul>
<li><p>Proporcionar un entorno homogéneo para la estimación polinómica
lócal multidimensional (tendencia, variograma, densidad, …),
especialmente para el caso de procesos espaciales (y
espacio-temporales).</p></li>
<li><p>Trata de minimizar el tiempo de computación y los requerimientos
de memoria.</p></li>
<li><p>Emplear clases y métodos S3 sencillos (que permitan interactuar
con las clases S4 del paquete <code>sp</code> y las nuevas S3 del
paquete <code>sf</code>; ver <code>npsp/inst/</code> <a href="https://github.com/rubenfcasal/npsp/blob/master/inst/locpol_classes.pdf" class="external-link">locpol_classes.pdf</a>).</p></li>
<li><p>Robusto y que facilite la implementación de nuevos
métodos.</p></li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="binning-lineal">Binning lineal<a class="anchor" aria-label="anchor" href="#binning-lineal"></a>
</h2>
<p>Para acelerar los cálculos se emplea binning (WARPing; e.g. Wand and
Jones, 1995):</p>
<ul>
<li>datos <span class="math inline">\(\Longrightarrow\)</span>
discretización <span class="math inline">\(\Longrightarrow\)</span>
suavizado <span class="math inline">\(\Longrightarrow\)</span>
interpolación</li>
</ul>
<p>Normalmente el resultado final del análisis es una rejilla y el
último paso sólo interesa en cálculos intermedios (e.g. obtención de
residuos).</p>
<div class="section level3">
<h3 id="discretización">Discretización<a class="anchor" aria-label="anchor" href="#discretizaci%C3%B3n"></a>
</h3>
<p>En la estimación polinómica local se emplea binning lineal.</p>
<ul>
<li>Wand M.P. and Jones M.C. (1995) <em>Kernel Smoothing</em>. Chapman
and Hall.</li>
</ul>
<p>Las principales funciones son:</p>
<ul>
<li><p>Tendencia (y densidad): <a href="https://rubenfcasal.github.io/npsp/reference/binning.html" class="external-link"><code>binning</code></a>.</p></li>
<li><p>Variograma: <a href="https://rubenfcasal.github.io/npsp/reference/svar.bin.html" class="external-link"><code>svar.bin</code></a></p></li>
</ul>
<p>Normalmente se emplearan dos rejillas, una de baja resolución para
acelerar los cálculos durante el proceso de modelado (selección de la
ventana, cálculos intermedios, …) y otra con la resolución deseada para
obtener los resultados finales.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/cpu.time.html">cpu.time</a></span><span class="op">(</span>reset<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code>CPU time has been initialized.</code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bin</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/binning.html">binning</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, nbin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">41</span>,<span class="fl">41</span><span class="op">)</span>, set.NA <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> </span>
<span><span class="fu"><a href="../../reference/simage.html">simage</a></span><span class="op">(</span><span class="va">bin</span>, main <span class="op">=</span> <span class="st">'Binning averages'</span><span class="op">)</span></span>
<span><span class="co"># Data points</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">bin</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">x</span>, col <span class="op">=</span> <span class="st">'darkgray'</span><span class="op">)</span></span>
<span><span class="co"># Binning grid</span></span>
<span><span class="va">coordvs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/coordvalues.html">coordvalues</a></span><span class="op">(</span><span class="va">bin</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="va">coordvs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, lty <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="va">coordvs</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, lty <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="aquifer_files/figure-html/binning-1.png" width="576" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/cpu.time.html">cpu.time</a></span><span class="op">(</span>total <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code>Time of last operation: 
   user  system elapsed 
   0.02    0.00    0.01 </code></pre>
</div>
<div class="section level3">
<h3 id="interpolación">Interpolación<a class="anchor" aria-label="anchor" href="#interpolaci%C3%B3n"></a>
</h3>
<p>En el paquete se emplea interpolación lineal (algoritmo análogo al
binning lineal). Métodos:</p>
<ul>
<li>
<a href="https://rubenfcasal.github.io/npsp/reference/interp.html" class="external-link"><code>interp</code></a>
y <a href="https://rubenfcasal.github.io/npsp/reference/interp.html" class="external-link"><code>predict</code></a>
</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="estimación-de-la-densidad">Estimación de la densidad<a class="anchor" aria-label="anchor" href="#estimaci%C3%B3n-de-la-densidad"></a>
</h2>
<p>La estimación de la densidad está implementada como un caso
particular de regresión (se suavizan los pesos binning reescalados):</p>
<ul>
<li>
<a href="https://rubenfcasal.github.io/npsp/reference/np.den.html" class="external-link"><code>np.den</code></a>.</li>
</ul>
<p>Por defecto emplea el estimador lineal local (establecer
<code>degree = 0</code> para Nadaraya-Watson).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">den</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/np.den.html">np.den</a></span><span class="op">(</span><span class="va">bin</span>, h <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">60</span>, <span class="fl">2</span><span class="op">)</span>, degree <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> </span>
<span><span class="co"># alternatively, set h = h.cv(as.bin.den(bin))$h</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">den</span>, main <span class="op">=</span> <span class="st">'Estimated log(density)'</span><span class="op">)</span></span></code></pre></div>
<p><img src="aquifer_files/figure-html/np.den-1.png" width="576" style="display: block; margin: auto;"></p>
<p>Se puede emplear por ejemplo para establecer una máscara que filtre
las posiciones alejadas de los datos.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bin</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/mask.html">mask</a></span><span class="op">(</span><span class="va">bin</span>, mask <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">den</span><span class="op">$</span><span class="va">est</span><span class="op">)</span> <span class="op">&gt;</span> <span class="op">-</span><span class="fl">14</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">bin</span><span class="op">)</span></span></code></pre></div>
<pre><code>List of 5
 $ biny: num [1:41, 1:41] NA NA NA NA NA NA 35.1 35.1 NA NA ...
 $ binw: num [1:41, 1:41] 0 0 0 0 0 ...
 $ grid:List of 6
  ..$ nd      : int 2
  ..$ n       : int [1:2] 41 41
  ..$ min     : num [1:2] -145.24 9.41
  ..$ max     : num [1:2] 113 185
  ..$ lag     : num [1:2] 6.45 4.38
  ..$ dimnames: chr [1:2] "lon" "lat"
  ..- attr(*, "class")= chr "grid.par"
 $ data:List of 3
  ..$ x  : num [1:85, 1:2] 42.78 -27.4 -1.16 -18.62 96.47 ...
  .. ..- attr(*, "dimnames")=List of 2
  .. .. ..$ : chr [1:85] "1" "2" "3" "4" ...
  .. .. ..$ : chr [1:2] "lon" "lat"
  ..$ y  : num [1:85] 14.6 25.5 21.6 24.6 17.6 ...
  ..$ med: num 20
 $ mask: logi [1:41, 1:41] TRUE TRUE TRUE TRUE TRUE TRUE ...
 - attr(*, "class")= chr [1:3] "bin.data" "bin.den" "data.grid"</code></pre>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/cpu.time.html">cpu.time</a></span><span class="op">(</span>total <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code>Time of last operation: 
   user  system elapsed 
   0.19    0.01    0.21 </code></pre>
</div>
<div class="section level2">
<h2 id="estimación-de-la-tendencia">Estimación de la tendencia<a class="anchor" aria-label="anchor" href="#estimaci%C3%B3n-de-la-tendencia"></a>
</h2>
<div class="section level3">
<h3 id="regresión-polinómica-local">Regresión polinómica local<a class="anchor" aria-label="anchor" href="#regresi%C3%B3n-polin%C3%B3mica-local"></a>
</h3>
<p>En el caso univariante, para cada <span class="math inline">\(x_{0}\)</span> se ajusta un polinomio: <span class="math display">\[\beta_{0}+\beta_{1}\left(x - x_{0}\right) +
\cdots
+ \beta_{p}\left( x-x_{0}\right)^{p}\]</span> por mínimos cuadrados
ponderados, con pesos <span class="math inline">\(w_{i} =
\frac{1}{h}K\left(\frac{x-x_{0}}{h}\right)\)</span>.</p>
<ul>
<li><p>La estimación en <span class="math inline">\(x_{0}\)</span> es
<span class="math inline">\(\hat{\mu}_{h}(x_{0})=\hat{\beta}_{0}\)</span>.</p></li>
<li><p>Adicionalmente: <span class="math inline">\(\widehat{\mu_{h}^{r)}}(x_{0}) =
r!\hat{\beta}_{r}\)</span>.</p></li>
</ul>
<p>Habitualmente se considera:</p>
<ul>
<li><p><span class="math inline">\(p=0\)</span>: Estimador
Nadaraya-Watson.</p></li>
<li><p><span class="math inline">\(p=1\)</span>: Estimador lineal
local.</p></li>
</ul>
<p>El caso multivariante es análogo. La estimación lineal local
multivariante <span class="math inline">\(\hat{\mu}_{\mathbf{H}}(\mathbf{x})=\hat{\beta}_{0}\)</span>
se obtiene al minimizar: <span class="math display">\[\min_{\beta_{0},\boldsymbol{\beta}_{1}}\sum_{i=1}^{n}
\left( Y(\mathbf{x}_{i})-\beta_{0}-{\boldsymbol{\beta}}_{1}^{t}
(\mathbf{x}_{i}-\mathbf{x})\right)^{2}
K_{\mathbf{H}}(\mathbf{x}_{i}-\mathbf{x}),\]</span> donde:</p>
<ul>
<li><p><span class="math inline">\(\mathbf{H}\)</span> es la matriz de
ventanas <span class="math inline">\(d\times d\)</span> (simétrica no
singular).</p></li>
<li><p><span class="math inline">\(K_{\mathbf{H}}(\mathbf{u})=\left\vert
\mathbf{H}\right\vert ^{-1}K(\mathbf{H}^{-1}\mathbf{u})\)</span> y <span class="math inline">\(K\)</span> núcleo multivariante.</p></li>
</ul>
<p>Explícitamente: <span class="math display">\[\hat{\mu}_{\mathbf{H}}(\mathbf{x}) =
\mathbf{e}_{1}^{t} \left(
\mathbf{X}_{\mathbf{x}}^{t} {\mathbf{W}}_{\mathbf{x}}
\mathbf{X}_{\mathbf{x}} \right)^{-1} \mathbf{X}_{\mathbf{x}}^{t}
{\mathbf{W}}_{\mathbf{x}}\mathbf{Y} \equiv
{s}_{\mathbf{x}}^{t}\mathbf{Y},\]</span> donde <span class="math inline">\(\mathbf{e}_{1} = \left( 1, \cdots,
0\right)^{t}\)</span>, <span class="math inline">\(\mathbf{X}_{\mathbf{x}}\)</span> es la matriz con
<span class="math inline">\((1,(\mathbf{x}_{i}-\mathbf{x})^{t})\)</span>
en fila <span class="math inline">\(i\)</span>, y <span class="math inline">\(\mathbf{W}_{\mathbf{x}} = \mathtt{diag} \left(
K_{\mathbf{H}}(\mathbf{x}_{1} - \mathbf{x}), ...,
K_{\mathbf{H}}(\mathbf{x}_{n}-\mathbf{x}) \right)\)</span> es la matriz
de pesos.</p>
<p>Se puede pensar que se obtiene aplicando un suavizado lineal a <span class="math inline">\((\mathbf{x}_i, Y(\mathbf{x}_i))\)</span>: <span class="math display">\[\hat{\boldsymbol{\mu}} = \mathbf{SY},\]</span>
siendo <span class="math inline">\(\mathbf{S}\)</span> la matriz de
suavizado con <span class="math inline">\(\mathbf{s}_{\mathbf{x}_{i}}^{t}\)</span> en la
fila <span class="math inline">\(i\)</span>.</p>
</div>
<div class="section level3">
<h3 id="implementación-en-el-paquete-npsp">Implementación en el paquete <code>npsp</code><a class="anchor" aria-label="anchor" href="#implementaci%C3%B3n-en-el-paquete-npsp"></a>
</h3>
<p>La estimación polinómica local está implementada en la función
genérica <a href="https://rubenfcasal.github.io/npsp/reference/locpol.html" class="external-link"><code>locpol</code></a>:</p>
<ul>
<li><p>Emplea una matriz de ventanas completa y un núcleo triweight para
el cálculo de los pesos.</p></li>
<li><p>Permite cálcular eficientemente la matriz de suavizado <span class="math inline">\(\mathbf{S}\)</span> (de utilidad en la estimación
de la dependencia, en la selección de la ventana, …).</p></li>
<li><p>Código <em>optimizado</em> para minimizar el tiempo de
computación y los requerimientos de memoria (especialmente para
validación cruzada, estimación del variograma, …). Los cálculos se
realizan en FORTRAN.</p></li>
<li><p>Para resolver el problema de regresión lineal (local), se emplea
(<a href="https://github.com/rubenfcasal/npsp/blob/master/src/dgelsyr.f" class="external-link"><code>src/dgelsyr.f</code></a>)
una modificación de la rutina DGELSY de la librería LAPACK (admite
matrices de rango deficiente).</p></li>
</ul>
</div>
<div class="section level3">
<h3 id="ejemplo-2">Ejemplo<a class="anchor" aria-label="anchor" href="#ejemplo-2"></a>
</h3>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/locpol.html">locpol</a></span><span class="op">(</span><span class="va">bin</span>, h <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">2</span><span class="op">)</span>, hat.bin <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>  </span>
<span><span class="co"># Perspective plot with a color scale</span></span>
<span><span class="fu"><a href="../../reference/spersp.html">spersp</a></span><span class="op">(</span><span class="va">lp</span>, main <span class="op">=</span> <span class="st">'Trend estimates'</span>, zlab <span class="op">=</span> <span class="st">'piezometric-head'</span>, theta <span class="op">=</span> <span class="fl">120</span><span class="op">)</span>   </span></code></pre></div>
<p><img src="aquifer_files/figure-html/unnamed-chunk-6-1.png" width="576" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/cpu.time.html">cpu.time</a></span><span class="op">(</span>total <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code>Time of last operation: 
   user  system elapsed 
   0.11    0.00    0.11 </code></pre>
</div>
</div>
<div class="section level2">
<h2 id="estimación-del-variograma">Estimación del variograma<a class="anchor" aria-label="anchor" href="#estimaci%C3%B3n-del-variograma"></a>
</h2>
<p>Al igual que en la geoestadística paramétrica tradicional, el
modelado de la dependencia se realiza a partir de los residuos: <span class="math display">\[e(\mathbf{x}_{i})=Y(\mathbf{x}_{i})-\hat{\mu}(\mathbf{x}_{i}).\]</span>
Si la media se supone cte. (proceso estacionario) se trabaja
directamente con las observaciones (se sustituiría <span class="math inline">\(e(\mathbf{x}_{i})\)</span> por <span class="math inline">\(Y(\mathbf{x}_{i})\)</span> en las
expresiones).</p>
<p>La estimación se realiza en dos pasos, en primer lugar se obtiene una
estimación piloto del variograma y posteriormente se ajusta un modelo
válido.</p>
<div class="section level3">
<h3 id="estimación-piloto-del-variograma">Estimación piloto del variograma<a class="anchor" aria-label="anchor" href="#estimaci%C3%B3n-piloto-del-variograma"></a>
</h3>
<p>En los métodos tradicionales se trata como un caso particular de
regresión: <span class="math display">\[\gamma\left(  \mathbf{x}_{i}-\mathbf{x}_{j}\right)  =\frac{1}{2}E\left(
\varepsilon(\mathbf{x}_{i})-\varepsilon(\mathbf{x}_{j})\right)^{2}\]</span>
con <span class="math inline">\(N=\frac{n(n-1)}{2}\)</span>
observaciones: <span class="math display">\[{\left(\mathbf{x}_{i}-\mathbf{x}_{j},
(e(\mathbf{x}_{i})-e(\mathbf{x}_{j}))^2 / 2 \right)},\]</span> asumiendo
que la variabilidad de los residuos es (similar a) la de los
errores.</p>
<p>La estimación polinómico local <span class="math inline">\(\hat{\gamma}_{\mathbf{G}}(\mathbf{u}) =
\hat{\beta}_{0}\)</span> se obtendría minimizando: <span class="math display">\[\begin{aligned}
\min_{\beta_{0}, \boldsymbol{\beta}_{1}, \cdots}
\sum_{i=1}^{n}\left( \frac{1}{2} \left(
e(\mathbf{x}_{i})-e(\mathbf{x}_{j})
\right)^{2} - \beta_{0} - {\boldsymbol{\beta}}_{1}^{t} (\mathbf{x}_{i} -
\mathbf{x}_{j} - \mathbf{u}) - \cdots\right)  ^{2}\times &amp; \\
K_{\mathbf{G}}(\mathbf{x}_{i}-\mathbf{x}_{j}-\mathbf{u})  &amp;
\end{aligned},\]</span> siendo <span class="math inline">\(\mathbf{G}\)</span> la correspondiente matriz de
ventanas.</p>
<p>Actualmente en el paquete <code>npsp</code> solo está implementado el
caso isotrópico:</p>
<ul>
<li><p><a href="https://rubenfcasal.github.io/npsp/reference/svar.bin.html" class="external-link"><code>svar.bin</code></a>:
estimador empírico con binning lineal.</p></li>
<li><p><a href="https://rubenfcasal.github.io/npsp/reference/np.svar.html" class="external-link"><code>np.svar</code></a>:
estimador polinómico local.</p></li>
</ul>
<p>Estas funciones son adecuadas para procesos estacionarios y se
podrían emplear en el caso no estacionario para estimar el variograma
residual (sesgado) calculando previamente los residuos.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lp.resid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">lp</span><span class="op">)</span></span>
<span><span class="va">esvar0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/np.svar.html">np.svariso</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">lp.resid</span>, nlags <span class="op">=</span> <span class="fl">50</span>, h <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">esvar0</span>, main <span class="op">=</span> <span class="st">"Nonparametric (residual) pilot semivariogram"</span><span class="op">)</span></span></code></pre></div>
<p><img src="aquifer_files/figure-html/unnamed-chunk-7-1.png" width="672" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/cpu.time.html">cpu.time</a></span><span class="op">(</span>total <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code>Time of last operation: 
   user  system elapsed 
   0.12    0.00    0.12 </code></pre>
</div>
<div class="section level3">
<h3 id="estimación-piloto-del-variograma-con-corrección-de-sesgo">Estimación piloto del variograma con corrección de sesgo<a class="anchor" aria-label="anchor" href="#estimaci%C3%B3n-piloto-del-variograma-con-correcci%C3%B3n-de-sesgo"></a>
</h3>
<p>El uso directo de los residuos <span class="math inline">\(\boldsymbol{\hat{\varepsilon}} = \mathbf{Y} -
\hat{\boldsymbol{\mu}} = (\mathbf{I - S})\mathbf{Y}\)</span> introduce
un sesgo en la estimación del variograma, ya que su variabilidad es
distinta de la de los errores: <span class="math display">\[Var(\boldsymbol{\hat{\varepsilon}}) =
{\boldsymbol{\Sigma}}_{\hat{\varepsilon}}
= \boldsymbol{\Sigma} + \mathbf{B},\]</span> siendo <span class="math inline">\(\mathbf{B} = \mathbf{S} \boldsymbol{\Sigma}
\mathbf{S}^{t} - \boldsymbol{\Sigma} \mathbf{S}^{t} - \mathbf{S}
\boldsymbol{\Sigma}\)</span> la matriz de sesgos.</p>
<p>En términos del variograma: <span class="math display">\[Var\left(\hat{\varepsilon}(\mathbf{x}_i)
- \hat{\varepsilon}(\mathbf{x}_j) \right) =
Var\left(\varepsilon(\mathbf{x}_i) - \varepsilon(\mathbf{x}_j) \right)
+ b_{ii} + b_{jj} - 2 b_{ij}.\]</span> Este sesgo es normalmente
negativo y mayor en saltos grandes (ver p.e. Cressie, 1993, sección
3.4.3). En Fernandez-Casal y Francisco-Fernandez (2013) se propone un
método iterativo para su corrección. La función
<code>np.svariso.corr</code> implementa un algoritmo similar (totalmente
no paramétrico). Comenzando con el estimador lineal local residual
anterior, en cada iteración <span class="math inline">\(k\)</span> se
actualizan las diferencias <span class="math inline">\((\hat{\varepsilon}(\mathbf{x}_i)-
\hat{\varepsilon}(\mathbf{x}_j))^2\)</span> reemplazándolas por: <span class="math display">\[(\hat{\varepsilon}(\mathbf{x}_i)-
\hat{\varepsilon}(\mathbf{x}_j))^2
- \hat{b}_{ii}^{(k-1)} - \hat{b}_{jj}^{(k-1)} + 2
\hat{b}_{ij}^{(k-1)},\]</span> siendo <span class="math inline">\(\hat{\mathbf{B}}^{(k-1)}\)</span> la aproximación
del sesgo obtenida en la iteración anterior.</p>
<p>Ejemplo:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">esvar</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/np.svar.html">np.svariso.corr</a></span><span class="op">(</span><span class="va">lp</span>, nlags <span class="op">=</span> <span class="fl">50</span>, h <span class="op">=</span> <span class="fl">50</span>, plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="aquifer_files/figure-html/np.svariso.corr-1.png" width="672" style="display: block; margin: auto;"></p>
<pre><code>Iteration  2 :  1 
Iteration  3 :  0.1071746 
Iteration  4 :  0.07731208 
Iteration  5 :  0.06118289 
Iteration  6 :  0.05087295 
Iteration  7 :  0.04358588 </code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/cpu.time.html">cpu.time</a></span><span class="op">(</span>total <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code>Time of last operation: 
   user  system elapsed 
   0.14    0.00    0.14 </code></pre>
</div>
<div class="section level3">
<h3 id="ajuste-de-un-modelo-no-paramétrico">Ajuste de un modelo no paramétrico<a class="anchor" aria-label="anchor" href="#ajuste-de-un-modelo-no-param%C3%A9trico"></a>
</h3>
<p>Los estimadores piloto no verifican las propiedades de un variograma
(condicionalmente semidefinidos negativos) y no pueden ser usados en
predicción espacial (kriging). Para resolver este problema se ajusta un
modelo válido.</p>
<p>La función <a href="https://rubenfcasal.github.io/npsp/reference/fitsvar.sb.iso.html" class="external-link"><code>fitsvar.sb.iso</code></a>
permite ajustar un modelo no paramétrico de Shapiro-Botha. En el caso
isotrópico son de la forma: <span class="math display">\[\gamma(\left\Vert \mathbf{u} \right\Vert ) =
\nu_{0} -
    \sum\limits_{k=1}^{K}\kappa_{d}(x_{k}\left\Vert
\mathbf{u}\right\Vert )
    z_{k},\]</span> siendo:</p>
<ul>
<li><p><span class="math inline">\(\kappa_{d}(x) = \left(
\tfrac{2}{x}\right)^{{\frac{d{-2}}{2}}} \Gamma\left( \tfrac{d}{2}\right)
J_{{\frac{d{-2}}{2}}}(x)\)</span>, donde <span class="math inline">\(J_p\)</span> es la función de Bessel de orden
<span class="math inline">\(p\)</span>.</p></li>
<li><p><span class="math inline">\(x_{k}\)</span> nodos de
discretización (siguiendo la recomendación de Gorsich y Genton, 2004, se
establecen reescalando los ceros de las funciones de Bessel (ver <a href="https://rubenfcasal.github.io/npsp/reference/disc.sb.html" class="external-link"><code>disc.sb</code></a>).).</p></li>
<li><p><span class="math inline">\(\left( z_{1}, ..., z_{K}, \nu_{0}
\right)^{t}\)</span> parámetros, verificando: <span class="math display">\[z_{k} \geq0 \text{ y }
c_{0} =  \nu_{0}-\sum\nolimits_{k=1}^{K}z_{k}\geq0.\]</span></p></li>
</ul>
<p>El ajuste por WLS a un conjunto de estimaciones piloto se puede
realizar fácilmente mediante programación cuadrática (modificación de la
función <code>solve.QP</code> del paquete <code>quadprog</code> para
obtener la solución de problemas no estrictamente convexos).</p>
<p>Estos modelos son muy flexibles por lo que es habitual considerar una
dimensión <span class="math inline">\(d\)</span> mayor que la de los
datos para obtener ajustes más suaves (empleando el parámetro
<code>dk</code>). En el límite obtendríamos <span class="math inline">\(\kappa_{\infty}(x)\equiv e^{-x^{2}}\)</span>, que
se correspondería con un modelo válido en cualquier dimensión (se
selecciona estableciendo<code>dk = 0</code>).</p>
<p>Ejemplo:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/fitsvar.sb.iso.html">fitsvar.sb.iso</a></span><span class="op">(</span><span class="va">esvar</span>, dk <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">svm</span>, main <span class="op">=</span> <span class="st">"Nonparametric semivariogram and fitted model"</span><span class="op">)</span></span>
<span><span class="va">svm0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/fitsvar.sb.iso.html">fitsvar.sb.iso</a></span><span class="op">(</span><span class="va">esvar0</span>, dk <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">svm0</span><span class="op">$</span><span class="va">fit</span>, <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">u</span>, <span class="va">fitted.sv</span>, lty <span class="op">=</span> <span class="fl">3</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="aquifer_files/figure-html/unnamed-chunk-8-1.png" width="672" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/cpu.time.html">cpu.time</a></span><span class="op">(</span>total <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code>Time of last operation: 
   user  system elapsed 
   0.11    0.00    0.11 </code></pre>
<p>Estos modelos son extensibles al caso anisotrópico (Fernandez-Casal
<em>et al</em>., 2003), adecuado para procesos espacio-temporales.</p>
</div>
</div>
<div class="section level2">
<h2 id="selección-de-las-ventanas">Selección de las ventanas<a class="anchor" aria-label="anchor" href="#selecci%C3%B3n-de-las-ventanas"></a>
</h2>
<p>La función genérica <a href="https://rubenfcasal.github.io/npsp/reference/h.cv.html" class="external-link"><code>h.cv</code></a>
permite seleccionar la ventana de una estimación polinómico local (de la
tendencia, densidad o variograma) usando criterios de validación cruzada
(CV), validación cruzada generalizada (GCV) o MASE (estándar y
modificados).</p>
<div class="section level3">
<h3 id="estimación-de-la-tendencia-1">Estimación de la tendencia<a class="anchor" aria-label="anchor" href="#estimaci%C3%B3n-de-la-tendencia-1"></a>
</h3>
<p>Con los criterios de selección de la ventana diseñados para datos
independientes se tiende a infrasuavizar la estimación (e.g. Opsomer et
al, 2001):</p>
<ul>
<li><p>Validación cruzada tradicional (LOOCV): <span class="math display">\[CV(\mathbf{H})=\frac{1}{n}\sum_{i=1}^{n}
\left( Y(\mathbf{x}_{i}) - \hat{\mu}_{-i}(\mathbf{x}_{i})
\right)^{2},\]</span> siendo <span class="math inline">\(\hat{\mu}_{-i}(\mathbf{x}_{i})\)</span> la
estimación obtenida eliminando el dato <span class="math inline">\(i\)</span>-ésimo.</p></li>
<li><p>Validación cruzada generalizada (Craven y Wahba, 1978): <span class="math display">\[GCV(\mathbf{H})=\frac{1}{n}\sum_{i=1}^{n}
\left(  \frac{Y(\mathbf{x}_{i}) -\hat{\mu}(\mathbf{x}_{i})}
{1-\frac{1}{n}tr\left( \mathbf{S}\right) }\right)^{2}.\]</span></p></li>
</ul>
<p>Por ello se han propuesto distintos criterios alternativos para el
caso de datos dependientes:</p>
<ul>
<li><p>Validación cruzada modificada (Chu and Marron, 1991): <span class="math display">\[MCV(\mathbf{H})=\frac{1}{n}\sum_{i=1}^{n}\left(  Y(\mathbf{x}_{i})-\hat
{\mu}_{-N(i)}(\mathbf{x}_{i})\right)^{2},\]</span> siendo <span class="math inline">\(\hat{\mu}_{-i}(\mathbf{x}_{i})\)</span> la
estimación obtenida eliminando los datos en un vecindario <span class="math inline">\(N(i)\)</span> de <span class="math inline">\(\mathbf{x}_{i}\)</span>.</p></li>
<li><p>Validación cruzada generalizada con corrección de sesgo para
dependencia (Francisco-Fernandez and Opsomer, 2005): <span class="math display">\[CGCV(\mathbf{H})=\frac{1}{n}\sum_{i=1}^{n}
\left(  
\frac{Y(\mathbf{x}_{i}) -\hat{\mu}(\mathbf{x}_{i})} {1 -
\frac{1}{n}tr\left( \mathbf{S} \hat{\mathbf{R}} \right)
}\right)^{2},\]</span> siendo <span class="math inline">\(\hat{\mathbf{R}}\)</span> una estimación de la
matriz de correlaciones.</p></li>
</ul>
<p>Adicionalmente, reescribiendo el criterio MCV de la forma: <span class="math display">\[MCV(\mathbf{H}) = \frac{1}{n}  \left(
\mathbf{Y}-\mathbf{S}_{-N} \mathbf{Y}\right) ^{t} \left(
\mathbf{Y}-\mathbf{S}_{-N} \mathbf{Y} \right),\]</span> donde <span class="math inline">\(N = \left\lbrace N(1),\ldots, N(n)
\right\rbrace\)</span>, puede verse que: <span class="math display">\[\mathrm{E}\left( MCV(\mathbf{H})\right) \simeq
MASE(\mathbf{H}) +
\sigma^{2} -
\frac{2}{n}tr\left(\mathbf{S}_{-N}\boldsymbol{\Sigma}\right),\]</span>
siendo: <span class="math display">\[MASE(\mathbf{H})=
\frac{1}{n}\mathbb{E}\left( \left(
\mathbf{SY}-\boldsymbol{\mu}\right)^{t} \left(
\mathbf{SY}-\boldsymbol{\mu}\right) \right) = \\
=
\frac{1}{n}\left(\mathbf{S}\boldsymbol{\mu}-\boldsymbol{\mu}\right)^{t}
\left( \mathbf{S}\boldsymbol{\mu}-\boldsymbol{\mu}\right) +
\frac{1}{n}tr\left( \mathbf{S}\boldsymbol{\Sigma
}\mathbf{S}^{t}\right).\]</span></p>
<ul>
<li><p>Validación cruzada modificada corregida (Fernández-Casal et al,
Preprint): <span class="math display">\[CMCV(\mathbf{H}) =
\frac{1}{n}\sum_{i=1}^{n} \left(
Y(\mathbf{x}_{i}) - \hat{\mu}_{-N(i)}{(\mathbf{x_i)}} \right)^{2} +
\frac{2}{n}tr\left( \mathbf{S}_{-N}
\hat{\boldsymbol{\Sigma}}\right).\]</span> <span class="math inline">\(CCV\)</span> sería un caso particular tomando
<span class="math inline">\(N = N_1 = \left\lbrace \{\mathbf{x}_{1}\},
\ldots, \{\mathbf{x}_{n}\}\right\rbrace\)</span>.</p></li>
<li><p>Ventana por bootstrap suavizado: El criterio <span class="math inline">\(MASE(\mathbf{H})\)</span> puede ser empleado
cuando se conocen la media y varianzas teóricas (p.e. en simulación),
pero si se sustituyen por estimaciones, obtendríamos la ventana óptima
MASE de la correspondiente distribución bootstrap.</p></li>
</ul>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#   Example:</span></span>
<span><span class="va">bin2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/binning.html">binning</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>     <span class="co"># sets nbin automatically</span></span>
<span><span class="fu"><a href="../../reference/h.cv.html">h.cv</a></span><span class="op">(</span><span class="va">bin2</span>, h.start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span>                <span class="co"># MCV (ncv = 2)</span></span></code></pre></div>
<pre><code>$h
         [,1]   [,2]
[1,] 150.2659  0.000
[2,]   0.0000 82.392

$value
[1] 3.989047

$objective
[1] "CV"</code></pre>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># cov.bin &lt;-  varcov(svm2, coords = coords(bin2))</span></span>
<span><span class="va">lp.h</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/h.cv.html">h.cv</a></span><span class="op">(</span><span class="va">bin2</span>, cov.bin <span class="op">=</span> <span class="va">svm</span>, h.start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="co"># CMCV (ncv = 2)</span></span>
<span><span class="va">lp.h</span></span></code></pre></div>
<pre><code>$h
         [,1]    [,2]
[1,] 403.1891   0.000
[2,]   0.0000 208.273

$value
[1] 5.925639

$objective
[1] "CV"</code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/cpu.time.html">cpu.time</a></span><span class="op">(</span>total <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code>Time of last operation: 
   user  system elapsed 
   0.52    0.07    0.58 </code></pre>
<p>Hay que tener cuidado con los algoritmos de optimización automáticos.
Por defecto se emplea el método “L-BFGS-B” de la función
<code>optim</code>. Como se trata de una minimización no lineal
multidimensional puede haber problemas de mínimos locales. Para intentar
evitar este problema se puede establecer unos valores iniciales para los
parámetros de la ventana mediante el argumento <code>h.start</code>.
Alternativamente se puede establecer el parámetro
<code>DEalgorithm = TRUE</code> para utilizar el algoritmo genético de
optimización del paquete <code>DEoptim</code> (aunque puede aumentar
considerablemente el tiempo de computación).</p>
<p>Empleando la ventana seleccionada se podría reestimar de nuevo la
tendencia, aunque también habría que volver a estimar el variograma (si
se modifica la variabilidad de gran escala, habría que actualizar la
variabilidad de pequeña escala). Este procedimento se podría repetir
iterativamente. Se tratará más adelante en la sección “<a href="Estimaci%C3%B3n%20conjunta%20(autom%C3%A1tica)">Estimación conjunta
(automática)</a>”.</p>
</div>
<div class="section level3">
<h3 id="estimación-del-variograma-1">Estimación del variograma<a class="anchor" aria-label="anchor" href="#estimaci%C3%B3n-del-variograma-1"></a>
</h3>
<p>La ventana para la estimación del variograma puede seleccionarse por
ejemplo minimizando el correspondiente error cuadrático de validación
cruzada: <span class="math display">\[\sum\limits_{i=1}^{n-1}\sum\limits_{j=i+1}^{n}
\left( \left( \hat{\varepsilon}(\mathbf{x}_{i})
- \hat{\varepsilon}(\mathbf{x}_{j})\right)^{2}
- 2\hat{\gamma}_{-(i,j)}\left( \left\Vert \mathbf{x}_{i}
- \mathbf{x}_{j}\right\Vert \right) \right) ^{2},\]</span> siendo <span class="math inline">\(\hat{\gamma}_{-(i,j)}(\cdot )\)</span> la
estimación obtenida descartando <span class="math inline">\(\left(
\hat{\varepsilon}(\mathbf{x}_{i}) -
\hat{\varepsilon}(\mathbf{x}_{j})\right) ^{2}\)</span>. Sin embargo,
para tener un mejor ajuste cerca del origen, suele ser preferible
emplear el error cuadrático relativo de validación cruzada: <span class="math display">\[\sum\limits_{i=1}^{n-1}\sum\limits_{j=i+1}^{n}\left(
\frac{\left( \hat{
\varepsilon}(\mathbf{x}_{i})-\hat{\varepsilon}(\mathbf{x}_{j})\right)
^{2}
}{2\hat{\gamma}_{-(i,j)}\left( \left\Vert \mathbf{x}_{i}-\mathbf{x}
_{j}\right\Vert \right) }-1\right) ^{2}.\]</span> Adicionalmente, si hay
datos atípicos, sería recomendable emplear un error absoluto en lugar de
cuadrático.</p>
<p>Ninguno de estos criterios tiene en cuenta la dependencia entre las
semivarianzas, por lo que las ventanas seleccionadas tenderán a
infrasuavizar (especialmente en saltos grandes). Si se emplea un
procedimiento automático, puede ser recomendable incrementar la ventana
obtenida con estos criterios (en el algoritmo automático implementado en
<code>np.fitgeo</code> descrito a continuación, si no se especifica la
ventana para la estimación del variograma, se incrementa por defecto la
ventana obtenida con <code>h.cv</code> en un 50%).</p>
<p>NOTA: Actualmente sólo está implementada la estimación con ventana
global. En este caso, como las semivarianzas no son homocedásticas,
sería preferible emplear ventanas locales.</p>
</div>
</div>
<div class="section level2">
<h2 id="estimación-conjunta-automática">Estimación conjunta (automática)<a class="anchor" aria-label="anchor" href="#estimaci%C3%B3n-conjunta-autom%C3%A1tica"></a>
</h2>
<p>Como se comentó en la sección anterior, para poder seleccionar una
ventana “óptima” para la estimación de la tendencia es necesario
disponer de una estimación del variograma. Sin embargo, la estimación de
la dependencia requiere de una estimación de la tendencia. Para resolver
este problema circular se puede emplear un algoritmo iterativo (similar
al método de estimación paramétrica tradicional propuesto por Neuman y
Jacobson, 1984):</p>
<ol style="list-style-type: decimal">
<li><p>Seleccionar una ventana inicial <span class="math inline">\(\mathbf{H}^{(0)}\)</span> para <span class="math inline">\(\hat{\mu}\)</span> (usando por ejemplo <span class="math inline">\(MCV\)</span>).</p></li>
<li><p>Para <span class="math inline">\(k\geq 1\)</span>, usando la
ventana <span class="math inline">\(\mathbf{H}^{(k-1)}\)</span> calcular
<span class="math inline">\(\hat{\boldsymbol{\mu}} =
\mathbf{S}\mathbf{Y}\)</span> y los correspondientes residuos <span class="math inline">\(\hat{\boldsymbol{\varepsilon}}\)</span>.</p></li>
<li><p>Empleando el algoritmo para la corrección de sesgo, obtener una
estimación piloto <span class="math inline">\(\tilde{\gamma}(\cdot)\)</span>, y ajustar un
modelo S-B.</p></li>
<li><p>Construir <span class="math inline">\(\hat{\Sigma}^{(k)}\)</span>
y seleccionar una nueva ventana <span class="math inline">\(\mathbf{H}^{(k)}\)</span> (empleando <span class="math inline">\(CMCV\)</span> o <span class="math inline">\(CGCV\)</span>).</p></li>
<li><p>Repetir los pasos 2 al 4 hasta obtener convergencia.</p></li>
</ol>
<p>Este algoritmo está implementado en la función <a href="https://rubenfcasal.github.io/npsp/reference/np.fitgeo.html" class="external-link">np.fitgeo</a>
y normalmente dos iteraciones (el valor por defecto) son suficientes.
Por ejemplo, se podría hacer un modelado automático ejecutando:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">geom</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/np.fitgeo.html">np.fitgeo</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, svm.resid <span class="op">=</span> <span class="cn">TRUE</span>, h.start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../../reference/cpu.time.html">cpu.time</a></span><span class="op">(</span>total <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code>Time of last operation: 
   user  system elapsed 
   0.40    0.12    0.53 </code></pre>
<p>El parámetro <code>iter</code> controla el número máximo de
iteraciones del algoritmo completo. Estableciendo <code>iter = 0</code>
se emplea el variograma residual:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">geom0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/np.fitgeo.html">np.fitgeo</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, iter <span class="op">=</span> <span class="fl">0</span>, h.start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>La rutina devuelve el modelo no paramétrico ajustado, un objeto <a href="https://rubenfcasal.github.io/npsp/reference/np.geo.html" class="external-link">np.geo</a>
que contiene las estimaciones de la tendencia y del variograma. Al
representarlo gráficamente:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">geom</span><span class="op">)</span></span></code></pre></div>
<p><img src="aquifer_files/figure-html/plot.np.fitgeo-1.png" width="864" style="display: block; margin: auto;">
Además de las estimaciones finales de la tendencia y del variograma, se
muestra también el variograma ajustado obtenido en la iteración anterior
(y si <code>svm.resid = TRUE</code> el variograma residual). Si no hay
grandes diferencias no habría necesidad de seguir iterando, ya que el
criterio de selección de la ventana proporcionaría un suavizado
similar.</p>
</div>
<div class="section level2">
<h2 id="predicción-kriging">Predicción kriging<a class="anchor" aria-label="anchor" href="#predicci%C3%B3n-kriging"></a>
</h2>
<p>La función genérica <code>np.kriging</code> permite obtener
predicciones mediante kriging residual (combinando la estimación de la
tendencia con el kriging simple de los residuos). Actualmente solo está
implementado kriging simple y kriging residual con vecindario global.
Para la resolución del sistema de ecuaciones kriging, a partir de la
factorización de Choleski de la matriz de covarianzas, se emplea el
paquete <code>spam</code> para matrices dispersas.</p>
<p>Como ejemplo, compararemos las predicciones kriging obtenidas con el
ajuste automático con las correspondientes a la estimación con el
variograma residual.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">krig.grid0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/np.kriging.html">np.kriging</a></span><span class="op">(</span><span class="va">geom0</span>, ngrid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">96</span>, <span class="fl">96</span><span class="op">)</span><span class="op">)</span> <span class="co"># 9216 predicciones</span></span>
<span><span class="va">krig.grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/np.kriging.html">np.kriging</a></span><span class="op">(</span><span class="va">geom</span>, ngrid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">96</span>, <span class="fl">96</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../../reference/cpu.time.html">cpu.time</a></span><span class="op">(</span>total <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code>Time of last operation: 
   user  system elapsed 
   1.39    0.03    1.42 </code></pre>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">old.par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>, omd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.9</span>, <span class="fl">0.05</span>, <span class="fl">0.95</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">scale.range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">krig.grid0</span><span class="op">$</span><span class="va">trend</span>, <span class="va">krig.grid</span><span class="op">$</span><span class="va">trend</span>, finite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../../reference/simage.html">simage</a></span><span class="op">(</span> <span class="va">krig.grid0</span>, <span class="st">'trend'</span>, slim <span class="op">=</span> <span class="va">scale.range</span>, main <span class="op">=</span> <span class="st">'Trend estimates (residuals)'</span>, </span>
<span>        col <span class="op">=</span> <span class="fu"><a href="../../reference/splot.html">jet.colors</a></span><span class="op">(</span><span class="fl">256</span><span class="op">)</span>, legend <span class="op">=</span> <span class="cn">FALSE</span>, reset <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../../reference/simage.html">simage</a></span><span class="op">(</span> <span class="va">krig.grid</span>, <span class="st">'trend'</span>, slim <span class="op">=</span> <span class="va">scale.range</span>, main <span class="op">=</span> <span class="st">'Trend estimates (iteration 2)'</span>, </span>
<span>        col <span class="op">=</span> <span class="fu"><a href="../../reference/splot.html">jet.colors</a></span><span class="op">(</span><span class="fl">256</span><span class="op">)</span>, legend <span class="op">=</span> <span class="cn">FALSE</span>, reset <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">old.par</span><span class="op">)</span></span>
<span><span class="fu"><a href="../../reference/splot.html">splot</a></span><span class="op">(</span>slim <span class="op">=</span> <span class="va">scale.range</span>, col <span class="op">=</span> <span class="fu"><a href="../../reference/splot.html">jet.colors</a></span><span class="op">(</span><span class="fl">256</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="aquifer_files/figure-html/unnamed-chunk-9-1.png" width="864" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">old.par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>, omd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.9</span>, <span class="fl">0.05</span>, <span class="fl">0.95</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">scale.range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">krig.grid0</span><span class="op">$</span><span class="va">kpred</span>, <span class="va">krig.grid</span><span class="op">$</span><span class="va">kpred</span>, finite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../../reference/simage.html">simage</a></span><span class="op">(</span> <span class="va">krig.grid0</span>, <span class="st">'kpred'</span>, slim <span class="op">=</span> <span class="va">scale.range</span>, main <span class="op">=</span> <span class="st">'Kriging predictions (residuals)'</span>, </span>
<span>        col <span class="op">=</span> <span class="fu"><a href="../../reference/splot.html">jet.colors</a></span><span class="op">(</span><span class="fl">256</span><span class="op">)</span>, legend <span class="op">=</span> <span class="cn">FALSE</span>, reset <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../../reference/simage.html">simage</a></span><span class="op">(</span> <span class="va">krig.grid</span>, <span class="st">'kpred'</span>, slim <span class="op">=</span> <span class="va">scale.range</span>, main <span class="op">=</span> <span class="st">'Kriging predictions (iteration 2)'</span>, </span>
<span>        col <span class="op">=</span> <span class="fu"><a href="../../reference/splot.html">jet.colors</a></span><span class="op">(</span><span class="fl">256</span><span class="op">)</span>, legend <span class="op">=</span> <span class="cn">FALSE</span>, reset <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">old.par</span><span class="op">)</span></span>
<span><span class="fu"><a href="../../reference/splot.html">splot</a></span><span class="op">(</span>slim <span class="op">=</span> <span class="va">scale.range</span>, col <span class="op">=</span> <span class="fu"><a href="../../reference/splot.html">jet.colors</a></span><span class="op">(</span><span class="fl">256</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="aquifer_files/figure-html/unnamed-chunk-9-2.png" width="864" style="display: block; margin: auto;"></p>
<p>Hay que tener en cuenta que se trata de un método robusto y no
depende demasiado del modelo de tendencia (la variabilidad no explicada
por la tendencia es capturada por la variabilidad de pequeña escala). En
este caso es de especial importancia la estimación del variograma cerca
del origen.</p>
<p>Sin embargo, si se comparan las varianzas kriging (o se emplean otros
métodos de inferencia, como por ejemplo bootstrap) puede haber grandes
diferencias entre los resultados obtenidos con distintos modelos.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">old.par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>, omd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.9</span>, <span class="fl">0.05</span>, <span class="fl">0.95</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">scale.range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">krig.grid0</span><span class="op">$</span><span class="va">ksd</span>, <span class="va">krig.grid</span><span class="op">$</span><span class="va">ksd</span>, finite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../../reference/simage.html">simage</a></span><span class="op">(</span> <span class="va">krig.grid0</span>, <span class="st">'ksd'</span>, slim <span class="op">=</span> <span class="va">scale.range</span>, main <span class="op">=</span> <span class="st">'Kriging sd (residuals)'</span>, </span>
<span>        col <span class="op">=</span> <span class="fu"><a href="../../reference/splot.html">hot.colors</a></span><span class="op">(</span><span class="fl">256</span><span class="op">)</span>, legend <span class="op">=</span> <span class="cn">FALSE</span>, reset <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">aquifer</span>, <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">lon</span>, <span class="va">lat</span>, cex <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../../reference/simage.html">simage</a></span><span class="op">(</span> <span class="va">krig.grid</span>, <span class="st">'ksd'</span>, slim <span class="op">=</span> <span class="va">scale.range</span>, main <span class="op">=</span> <span class="st">'Kriging sd (iteration 2)'</span>, </span>
<span>        col <span class="op">=</span> <span class="fu"><a href="../../reference/splot.html">hot.colors</a></span><span class="op">(</span><span class="fl">256</span><span class="op">)</span>, legend <span class="op">=</span> <span class="cn">FALSE</span>, reset <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">aquifer</span>, <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">lon</span>, <span class="va">lat</span>, cex <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">old.par</span><span class="op">)</span></span>
<span><span class="fu"><a href="../../reference/splot.html">splot</a></span><span class="op">(</span>slim <span class="op">=</span> <span class="va">scale.range</span>, col <span class="op">=</span> <span class="fu"><a href="../../reference/splot.html">hot.colors</a></span><span class="op">(</span><span class="fl">256</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="aquifer_files/figure-html/unnamed-chunk-10-1.png" width="864" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/cpu.time.html">cpu.time</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>Time of last operation: 
   user  system elapsed 
   0.39    0.00    0.39 
Total time:
   user  system elapsed 
   3.39    0.23    3.62 </code></pre>
<div class="section level3">
<h3 id="futuras-implementaciones">Futuras implementaciones<a class="anchor" aria-label="anchor" href="#futuras-implementaciones"></a>
</h3>
<ul>
<li><p>Modelos anisotrópicos de semivariograma (caso
espacio-temporal).</p></li>
<li><p>Modelos aditivos y parcialmente lineales.</p></li>
<li><p>Modelos dinámicos.</p></li>
<li><p>Kriging local.</p></li>
<li><p>…</p></li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="referencias">Referencias<a class="anchor" aria-label="anchor" href="#referencias"></a>
</h2>
<ul>
<li><p>Chu, C.K. and Marron, J.S. (1991) Comparison of Two Bandwidth
Selectors with Dependent Errors. <em>The Annals of Statistics</em>,
<strong>19</strong>, 1906-1918.</p></li>
<li><p>Fernández-Casal R., Castillo-Páez S. and Francisco-Fernández M.
(2018), Nonparametric geostatistical risk mapping, <em>Stoch. Environ.
Res. Ris. Assess.</em>, <a href="https://doi.org/10.1007/s00477-017-1407-y" class="external-link">DOI</a>.</p></li>
<li><p>Fernández-Casal R., Castillo-Páez S. and García-Soidán P. (2017),
Nonparametric estimation of the small-scale variability of
heteroscedastic spatial processes, <em>Spa. Sta.</em>,
<strong>22</strong>, 358-370, <a href="https://doi.org/10.1016/j.spasta.2017.04.001" class="external-link">DOI</a>.</p></li>
<li><p>Fernandez-Casal R. and Francisco-Fernandez M. (2014)
Nonparametric bias-corrected variogram estimation under non-constant
trend, <em>Stoch. Environ. Res. Ris. Assess.</em>, <strong>28</strong>,
1247-1259.</p></li>
<li><p>Fernandez-Casal R., Gonzalez-Manteiga W. and Febrero-Bande M.
(2003) Flexible Spatio-Temporal Stationary Variogram Models,
<em>Statistics and Computing</em>, <strong>13</strong>,
127-136.</p></li>
<li><p>Francisco-Fernandez M. and Opsomer J.D. (2005) Smoothing
parameter selection methods for nonparametric regression with spatially
correlated errors. <em>Canadian Journal of Statistics</em>, 33,
539-558.</p></li>
<li><p>Rupert D. and Wand M.P. (1994) Multivariate locally weighted
least squares regression. <em>The Annals of Statistics</em>,
<strong>22</strong>, 1346-1370.</p></li>
<li><p>Shapiro A. and Botha J.D. (1991) Variogram fitting with a general
class of conditionally non-negative definite functions.
<em>Computational Statistics and Data Analysis</em>,
<strong>11</strong>, 87-96.</p></li>
<li><p>Wand M.P. (1994) Fast Computation of Multivariate Kernel
Estimators. <em>Journal of Computational and Graphical Statistics</em>,
<strong>3</strong>, 433-445.</p></li>
<li><p>Wand M.P. and Jones M.C. (1995) <em>Kernel Smoothing</em>.
Chapman and Hall, London.</p></li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://rubenfcasal.github.io" class="external-link">Ruben Fernandez-Casal</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
